# Tag与功能

max\_group功能依赖于识别Autoscaling（AWS）或者伸缩组（阿里云）所配置的tag来实现不同的功能，以下为tag key-value及功能解释

|                     tag-key                    |  默认值  |                                                                                                                                                                         功能                                                                                                                                                                         |   版本支持  |
| :--------------------------------------------: | :---: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | :-----: |
|        spotmax:detaching\_delay\_seconds       |   30  |                                                                                                                                                     当触发spot回收时，间隔多少秒后，将被回收机器从asg中detach，默认为30秒                                                                                                                                                     | ALI/AWS |
|          spotmax:is\_enable\_preaction         |  true |                                                                                                                                         增加此tag为开启集群防退化功能，此功能为预测即将被回收的机器，并提前进行更替机型操作，tag-value为true表示为开启此功能                                                                                                                                         | ALI/AWS |
|   spotmax:max\_num\_of\_terminated\_one\_time  |   1   |                                                                                                                                                       集群防退化功能一次关闭的最大机器数，替换机器执行分批替换，每次替换的最大数量                                                                                                                                                       | ALI/AWS |
| spotmax:preaction\_termination\_delay\_seconds |  600  |                                                                                                                                                               集群防退化功能执行terminate间隔时间                                                                                                                                                               | ALI/AWS |
|    spotmax:preaction\_detach\_delay\_seconds   |   30  |                                                                                                                                                         集群防退化功能中，将被替换机器间隔多少秒后，会被detach出asg                                                                                                                                                         | ALI/AWS |
|        spotmax:is\_enable\_od\_fallback        |  true |                                                                                                                                                  此tag-value为true表示，在前述中断预补偿机制中，当竞价实例无法获取时，会用按需实例补充                                                                                                                                                 | ALI/AWS |
|            spotmax:persistence\_dev            |  null |                                                                                                                                    添加此tag可以进行ebs的漂移，无默认值，tag-value为非root盘在instance上的映射路径，暂时仅aws平台支持，例如：/dev/sdf                                                                                                                                    | ALI/AWS |
|              spotmax:consul\_port              |  null |                                                                                                                 配置此参数为consul支持，无默认值，tag-value为consul agent本地端口号 在实例中断并经过detaching\_delay\_seconds时间后，该实例将会从consul的服务发现列表中移除，例如：8500                                                                                                                | ALI/AWS |
|         spotmax:k8s\_config\_file\_path        |  null |                                                                                                                                                   kubernetes 配置文件，用于把权限赋给max group，例如：xxx/config                                                                                                                                                   | ALI/AWS |
|     spotmax:k8s\_node\_drain\_grace\_second    |  null |                                                                                                                                                               node下的pod移出延迟时间，例如：600                                                                                                                                                               | ALI/AWS |
|           spotmax:spot\_price\_limit           |  null |                                                                                                                                            spot价格限制，例如 0.9， 当spot机型价格超过按需机型价格的90%，从替换机型列表中移出这个机型，例如：0.75                                                                                                                                           |   ALI   |
|        spotmax:fixed\_desired\_capacity        |  null |                                                                                                                                                                 重新设置伸缩组的机器的期望值，例如：3                                                                                                                                                                | ALI/AWS |
|                spotmax:alt(num)                |  null |                                                   <p>用于当伸缩组内的机器没有时，用额外的机器来替换，例子：</p><p>(<strong>key</strong>:spotmax:alt<strong>1</strong></p><p><strong>value</strong>:ecs.mn4.large)</p><p>(<strong>key</strong>:spotmax:alt<strong>2</strong></p><p><strong>value</strong>:ecs.n2.medium)</p>                                                   | ALI/AWS |
|               spotmax:ignore\_tag              | false |                                                                                                                                                          当tag-value为true时，maxGroup不管理此伸缩组                                                                                                                                                          | ALI/AWS |
|    spotmax:is\_to\_handle\_rebalance\_event    | false |                                                                                                                                                                    是否开启AWS容量再平衡                                                                                                                                                                    |   AWS   |
|    spotmax:is\_to\_handle\_scaling\_failure    |  true |                                                                                                                                                                   是否开启接收伸缩失败信息处理                                                                                                                                                                   | ALI/AWS |
|         spotmax:gurantee\_living\_mins         |  null |                                                                                                                                                              实例开启后不中断时长，最长设置60分钟，单位为分钟                                                                                                                                                             |   ALI   |
|              spotmax:buffer\_mins              |   1   |                                                                                                                                                              当设置不中断时间，误差值，建议1分钟，单位为分钟                                                                                                                                                              |   ALI   |
|            spotmax:is\_only\_od\_rep           | false |                                                                                                                                                                      只开od进行替换                                                                                                                                                                      |   AWS   |
|         spotmax:od\_least\_live\_hours         |   1   |                                                                                                                                                                   OD至少运行多长时间，单位小时                                                                                                                                                                  |   AWS   |
|         spotmax:sd\_delay\_detach\_secs        |   30  |                                                                                                                                                                     consul移除时间                                                                                                                                                                     | ALI/AWS |
|       spotmax:k8s\_delay\_draining\_secs       |   30  |                                                                                                                                                                       k8s移除时间                                                                                                                                                                      | ALI/AWS |
|  spotmax:warm\_pool\_start\_up\_duration\_min  |   1   |                                                                                                                                                             热池功能：实例开机多长时间后转换停止状态，单位为分钟                                                                                                                                                             |   AWS   |
|   spotmax:warm\_pool\_update\_frequency\_min   |   60  |                                                                                                                                                                  热池功能：实例更新频率，单位为分钟                                                                                                                                                                 |   AWS   |
|          spotmax:warm\_pool\_min\_size         |   0   |                                                                                                                                                        热池功能：开启多少个OD实例，当设置为-1时，为伸缩组的最大值与期望值之差                                                                                                                                                       |   AWS   |
|              spotmax:az\_rebalance             |  null | <p></p><p>自动控制AzRebalance。调整目标为各zone的总InService实例数均衡，不区分spot还是od（删除此Tag后需要人工设置Asg的AzRebalance状态); 取值2种，同时配置时需用逗号分割: (1) "true" -- 开启AzRebalance （2）"true,optimize" - 功能（1）开启， 且在持续优化时，把新实例补充到实例数最少的AZ。</p><p>补充：此tag对以下3类asg无效</p><ol><li>配置了spotmax:k8s_config_file_path的eks的节点组</li><li>配置了spotmax:persistence_dev的asg</li><li>单Az的asg</li></ol> |   AWS   |
| spotmax:spot\_supply\_checking\_interval\_mins |   60  |                                                                                                                                   主动优化时，检查spot库存恢复的最大间隔时间。默认值0会当做60分钟；建议在spot库存紧张开出很多od时，适当降低到5\~30min，值越小则检查越频繁                                                                                                                                   |   AWS   |

**注：当启用 spotmax:k8s\_node\_drain\_option 时，建议将spotmax:detaching\_delay\_seconds 的tag-value设置为80-90之间，这样可以在保证新node ready情况下，将pod转移过去。**
